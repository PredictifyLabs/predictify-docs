name: Protect Master & Develop Branches

on:
  push:
    branches:
      - master
      - develop

jobs:
  protect-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2   # Para leer correctamente el √∫ltimo commit

      - name: Prevent direct pushes to protected branches
        run: |
          echo "üîç Checking push event..."

          echo "Ref: $GITHUB_REF"
          echo "Event: $GITHUB_EVENT_NAME"

          # Obtener mensaje del √∫ltimo commit
          LAST_COMMIT_MSG="$(git log -1 --pretty=%B)"
          echo "Last commit message:"
          echo "$LAST_COMMIT_MSG"

          # Validar si el commit viene de un PR (todos los merges de PR tienen (#ID))
          if [[ "$LAST_COMMIT_MSG" != *"#"* ]]; then
            echo "‚ùå Direct push detected on $GITHUB_REF."
            echo "This branch ONLY accepts merges via Pull Request."
            exit 1
          fi

          echo "‚úî Protected branch policy satisfied. Detected merge from PR."
